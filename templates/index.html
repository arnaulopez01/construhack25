<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartVision</title>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://unpkg.com/three@0.147.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>

    <header class="app-header">
        <div class="header-logo">
            <i class="fa-solid fa-eye"></i> 
            <span>SmartVision<small>beta</small></span>
        </div>
        
        <div class="gemini-search-container">
            <div class="search-wrapper">
                <i class="fa-brands fa-google search-icon" title="Powered by Gemini"></i>
                <input type="text" id="gemini-prompt" placeholder="Pregunta a Gemini Flash 2.5 sobre la zona...">
                <button id="btn-send-prompt"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </header>

    <div id="map">
        
        <div class="map-buttons">
            <button id="layers-toggle" title="Gestionar Capas"><i class="fa-solid fa-layer-group"></i></button>
            <button id="toggle-3d" title="Alternar Vista 2D/3D"><i class="fa-solid fa-cube"></i></button>
            <button id="camera-button" title="Generar Foto"><i class="fa-solid fa-camera"></i></button>
        </div>

        <div id="layers-panel">
            <h4>Mapa Base</h4>
            <label class="layer-option"><input type="radio" name="base-layer" value="osm" checked> OSM</label>
            <label class="layer-option"><input type="radio" name="base-layer" value="esri-satellite"> Satélite</label>
            <label class="layer-option"><input type="radio" name="base-layer" value="esri-topo"> Topográfico</label>
            <hr>
            <h4>Capas Temáticas</h4>
            <label class="layer-option"><input type="checkbox" id="buildings-checkbox" checked> Edificios (3D)</label>
            <label class="layer-option"><input type="checkbox" id="population-points-checkbox"> Población (Puntos)</label>
            <label class="layer-option"><input type="checkbox" id="population-heatmap-checkbox"> Población (Calor)</label>
            <hr>
            <h4>Sensorica</h4>
            <label class="layer-option"><input type="checkbox" id="iot-checkbox"> Calidad Aire (Semáforo)</label>
            <label class="layer-option"><input type="checkbox" id="cameras-checkbox"> Cámaras DGT</label>
            <label class="layer-option"><input type="checkbox" id="solar-checkbox"> Placas Solares (Generación)</label>
            <hr>
            <h4>Urbanismo y entorno</h4>
            <label class="layer-option"><input type="checkbox" id="obras-checkbox"> Obras en Curso</label>
            <label class="layer-option"><input type="checkbox" id="bim-checkbox"> Torre Llevant (BIM)</label>
            <label class="layer-option"><input type="checkbox" id="terrain-3d-checkbox"> Relieve 3D (DTM)</label>
            <label class="layer-option"><input type="checkbox" id="catastro-checkbox"> Catastro (WMS)</label>
            
        </div>

        <div id="building-legend" class="map-overlay legend" style="display: none;">
            <h4>Uso del Edificio</h4>
            <div id="legend-content"></div>
        </div>

        <div id="iot-legend" class="map-overlay legend-iot" style="display: none;">
            <h4>Calidad del Aire</h4>
            <div id="iot-legend-content"></div>
        </div>

        <div id="heatmap-controls" class="map-overlay controls" style="display: none;">
            <h4>Control de Población</h4>
            <div class="slider-group">
                <label>Radio</label>
                <input type="range" id="heatmap-radius" min="5" max="50" step="1" value="20">
            </div>
            <div class="slider-group">
                <label>Intensidad</label>
                <input type="range" id="heatmap-intensity" min="0.1" max="3" step="0.1" value="1">
            </div>
        </div>

    </div>

    <div id="chat-overlay" class="chat-overlay" style="display: none;">
        <div class="chat-header">
            <span><i class="fa-solid fa-robot"></i> Respuesta Gemini</span>

            <button id="close-chat" onclick="document.getElementById('chat-overlay').style.display='none'">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="chat-content" class="chat-content">
        </div>
    </div>

    <div id="bim-popup" class="map-overlay" style="display: none; position: absolute; background: #2c3e50; color: white; padding: 10px; border-radius: 5px; z-index: 1000; pointer-events: none; max-width: 250px;"></div>

    <!-- MODAL DE OBRAS -->
    <div id="obra-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <h2 id="modal-obra-nombre">Nombre de la Obra</h2>
                    <div class="modal-subtitle">
                        <span id="modal-obra-badge" class="status-badge">Estado</span>
                        <span id="modal-obra-id" style="font-family:monospace;">ID: 0000</span>
                    </div>
                </div>
                <button class="close-modal-btn" onclick="closeObraModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="modal-body">
                <!-- Izquierda: Render -->
                <div class="modal-image-section">
                    <img id="modal-obra-img" src="" alt="Render" onerror="this.src='https://placehold.co/600x400?text=Sin+Imagen'">
                </div>
                
                <!-- Derecha: Datos -->
                <div class="modal-info-section">
                    <div class="description-box">
                        <span id="modal-obra-desc">Descripción...</span>
                    </div>

                    <div class="info-grid">
                        <div class="info-item"><label>Presupuesto</label><span id="modal-obra-presupuesto">-</span></div>
                        <div class="info-item"><label>Plazo</label><span id="modal-obra-plazo">-</span></div>
                        <div class="info-item"><label>Promotor</label><span id="modal-obra-promotor">-</span></div>
                        <div class="info-item"><label>Licencia</label><span id="modal-obra-licencia">-</span></div>
                    </div>

                    <div class="materials-section">
                        <h4>Materiales Clave</h4>
                        <div id="modal-obra-materiales" class="materials-list">-</div>
                    </div>
                    
                    <div id="modal-bim-container" style="display:none;">
                        <a href="#" class="bim-btn"><i class="fa-solid fa-cube"></i> Ver Modelo BIM</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="solar-modal" class="modal-overlay">
        <div class="modal-container" style="border-top: 5px solid #FFD600;"> <div class="modal-header">
                <div class="modal-title">
                    <h2 id="modal-solar-nombre">Nombre Instalación</h2>
                    <div class="modal-subtitle">
                        <i class="fa-solid fa-bolt" style="color:#FFD600;"></i>
                        <span id="modal-solar-potencia">0 kWp</span>
                    </div>
                </div>
                <button class="close-modal-btn" onclick="closeSolarModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="modal-body" style="display:block;">
                <div class="description-box" id="modal-solar-desc" style="margin-bottom: 20px;">
                    Descripción de la instalación...
                </div>

                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee;">
                    <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">Curva de Generación (Últimas 24h)</h4>
                    <div id="modal-solar-chart-container" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        const CONFIG = {
            lat: {{ start_lat }},
            lon: {{ start_lon }},
            zoom: {{ start_zoom }},
            maptilerKey: "{{ maptiler_api_key }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/bim_model.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>